{% extends 'base.html' %}

{% block content %}
    <div id="chat-box" class="chat-container">
        {% for message in messages  %}
            <div class="message-row {% if message.sender_id == request.user.pk %}own{% else %}other{% endif %}">
                <p><strong>{{ message.sender.username }}: </strong>{{ message.content }}</p>
            </div>
        {% endfor %}
        <div class="new-message">
            <input id="msg-input" type="text" placeholder="Type a message ...">
            <button id='send-button' onclick="sendMessage()">Send</button>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const threadId = '{{ thread.pk }}';
        const userId = '{{ request.user.pk }}';
        const socket = new WebSocket(`ws://${window.location.host}/ws/chat/${threadId}/`);

        socket.onmessage = function (e) {
          const data = JSON.parse(e.data);
          const msgBox = document.getElementById('chat-box');
          msgBox.innerHTML += `<p><strong>User ${data.sender_id}:</strong> ${data.content}</p>`
        };

        function sendMessage(){
            const input = document.getElementById('msg-input');
            const message = input.value;
            socket.send(JSON.stringify({content: message}));
            input.value = '';
        }

        let userMessage = document.getElementById('msg-input');
        let sendButton = document.getElementById('send-button');

        sendButton.disabled = !userMessage.value.trim();

        userMessage.addEventListener('input', () => {
            sendButton.disabled = !userMessage.value.trim();
        });

        userMessage.addEventListener('keydown', (event) => {
            if (event.key == 'Enter' && !sendButton.disabled) {
                event.preventDefault();
                sendButton.click();
            }
        })

    </script>
{% endblock %}